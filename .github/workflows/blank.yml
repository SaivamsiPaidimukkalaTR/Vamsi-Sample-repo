
# File: .github/workflows/ntg-workflow.yml
name: NTG Workflow

on:
  push:
    branches: [main]
  # pull_request:  # Uncomment if you also want PR runs

permissions:
  actions: write
  contents: read

jobs:
  set-run-name:
    runs-on: ubuntu-latest
    steps:
      - name: Gather run meta
        id: info
        shell: bash
        run: |
          echo "branch=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "date=$(date +%F)" >> "$GITHUB_OUTPUT"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR title (single line)
            printf 'title=%s\n' "${{ github.event.pull_request.title }}" | tr '\n' ' ' >> "$GITHUB_OUTPUT"
          else
            # Commit message (single line)
            printf 'title=%s\n' "${{ github.event.head_commit.message }}" | tr '\n' ' ' >> "$GITHUB_OUTPUT"
          fi
      - name: Get workflow_id
        id: wf
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        shell: bash
        run: |
          wid=$(gh api "repos/${{ github.repository }}/actions/runs/${{ github.run_id }}" --jq .workflow_id)
          echo "id=$wid" >> "$GITHUB_OUTPUT"
          echo $GH_TOKEN
          
      - name: Count todayâ€™s runs for this branch
        id: count
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        shell: bash
        run: |
          DATE="${{ steps.info.outputs.date }}"
          BRANCH="${{ steps.info.outputs.branch }}"
          WID="${{ steps.wf.outputs.id }}"
          COUNT=$(gh api "repos/${{ github.repository }}/actions/workflows/$WID/runs?branch=$BRANCH&per_page=100" \
            --jq "[.workflow_runs[] | select(.created_at | startswith(\"$DATE\"))] | length")
          echo "run_number=$((COUNT + 1))" >> "$GITHUB_OUTPUT"
          echo $GH_TOKEN
      - name: Cgacfxaxfha
    
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        shell: bash
        run: |
          gh api --hostname "${GITHUB_SERVER_URL#https://}" \
          "repos/${{ github.repository }}/actions/runs/${{ github.run_id }}" --jq '{id, name, event, repository: .repository.full_name}'
      
      - name: Set run name
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        shell: bash
        run: |
          HOST="${GITHUB_SERVER_URL:-https://github.com}" \
          #HOST="${HOST#https://}" \
          gh api --hostname "$HOST" \
          "repos/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          --jq '{id,name,repo:.repository.full_name,event}' 
      - name: Patch run name 
        run: | 
          HOST="${GITHUB_SERVER_URL:-https://github.com}" \
          HOST="${HOST#https://}" \
          NAME="${GITHUB_REF_NAME} - ${GITHUB_RUN_NUMBER} - $(date +%F)" \
          echo "Setting run name to: $NAME" \
          gh api --hostname "$HOST" \
          --method PATCH "repos/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          -f name="$NAME" -v
